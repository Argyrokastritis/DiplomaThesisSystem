<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <title>Καθηγητής - Πίνακας Ελέγχου</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      padding: 20px;
      max-width: 1000px;
      margin: auto;
      background: linear-gradient(135deg, #ece9e6, #ffffff);
      color: #333;
    }
    h2 { color: #444; text-align: center; margin-bottom: 20px; }
    h3 { color: #555; margin-bottom: 10px; }
    input, textarea, button, select {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: 0.3s;
    }
    button:hover {
      background-color: #45a049;
    }
    .section {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    .topic, .thesis {
      background: #fafafa;
      padding: 12px;
      margin-top: 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
    }
    .topic button, .thesis button {
      width: auto;
      margin-top: 8px;
      padding: 8px 12px;
      font-size: 13px;
    }
    .search-box {
  display: flex;
  gap: 8px;
  margin-bottom: 15px;
  align-items: center;
}

.search-box input {
  flex: 1;
  padding: 8px;
  font-size: 14px;
}

.search-box button {
  flex: 0;
  padding: 8px 14px;
  font-size: 14px;
  background-color: #007BFF;
  border-radius: 6px;
  border: none;
  color: white;
  cursor: pointer;
  transition: 0.3s;
}

.search-box button:hover {
  background-color: #0056b3;
}

  </style>
</head>
<body>

  <h2>👨‍🏫 Πίνακας Ελέγχου Καθηγητή</h2>

  <!-- Δημιουργία νέου θέματος -->
  <div class="section">
    <h3>➕ Δημιουργία Θέματος Διπλωματικής</h3>
    <form id="topicForm">
      <input type="text" id="title" placeholder="Τίτλος Θέματος" required>
      <textarea id="summary" placeholder="Σύντομη Περιγραφή" required></textarea>
      <input type="file" id="pdfFile">
      <button type="submit">Αποθήκευση Θέματος</button>
    </form>
  </div>

<!-- Αναζήτηση φοιτητή -->
<div class="section">
  <h3>🔍 Αναζήτηση Φοιτητή</h3>
  <div class="search-box">
    <input type="text" id="studentSearch" placeholder="Εισάγετε όνομα φοιτητή...">
    <button type="button" onclick="searchStudent()">Αναζήτηση</button>
  </div>
  <div id="studentResults"></div>
</div>

<script>
  async function searchStudent() {
    const query = document.getElementById('studentSearch').value.trim();
    if (!query) {
      studentResults.innerHTML = "<p>⚠️ Πληκτρολογήστε όνομα φοιτητή.</p>";
      return;
    }

    try {
      const res = await fetch(`http://localhost:5000/api/students/search?name=${encodeURIComponent(query)}`, {
        headers: { Authorization: `Bearer ${token}` }
      });

      if (!res.ok) {
        throw new Error("Σφάλμα επικοινωνίας με τον server");
      }

      const students = await res.json();
      studentResults.innerHTML = '';

      if (students.length === 0) {
        studentResults.innerHTML = "<p>❌ Δεν βρέθηκαν φοιτητές.</p>";
        return;
      }

      students.forEach(s => {
        const div = document.createElement('div');
        div.className = 'topic';
        div.innerHTML = `
          <strong>👨‍🎓 ${s.name}</strong><br>
          ΑΜ: ${s.am || '-'}<br>
          Email: ${s.email || '-'}
        `;
        studentResults.appendChild(div);
      });

    } catch (err) {
      console.error(err);
      studentResults.innerHTML = "<p>❌ Σφάλμα κατά την αναζήτηση.</p>";
    }
  }

  // ✅ Αναζήτηση και με Enter μέσα στο input
  document.getElementById('studentSearch').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      searchStudent();
    }
  });
</script>

  <!-- Λίστα θεμάτων -->
  <div class="section">
    <h3>📋 Θέματα που έχω δημιουργήσει</h3>
    <div id="topicList"></div>
  </div>

  <!-- Λίστα αναθέσεων -->
  <div class="section">
    <h3>📚 Αναθέσεις</h3>
    <div id="assignmentList"></div>
  </div>

  <script>
  const token = localStorage.getItem('token');
  if (!token) {
    alert('Πρέπει να συνδεθείτε πρώτα.');
    window.location.href = 'login.html';
  }

  const searchInput = document.getElementById('studentSearch');
  const studentResults = document.getElementById('studentResults');

  let searchTimeout;

  searchInput.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    const query = searchInput.value.trim();

    if (!query) {
      studentResults.innerHTML = '';
      return;
    }

    searchTimeout = setTimeout(() => searchStudent(query), 300);
  });

  async function searchStudent(query) {
    try {
      const res = await fetch(
        `http://localhost:5000/api/students/search?name=${encodeURIComponent(query)}`,
        { headers: { Authorization: `Bearer ${token}` } }
      );

      if (!res.ok) throw new Error("Σφάλμα επικοινωνίας με τον server");

      const students = await res.json();
      studentResults.innerHTML = '';

      if (students.length === 0) {
        studentResults.innerHTML = "<p>❌ Δεν βρέθηκαν φοιτητές.</p>";
        return;
      }

      const ul = document.createElement('ul');
      ul.style.listStyle = "none";
      ul.style.padding = "0";

      students.forEach(s => {
        const li = document.createElement('li');
        li.style.padding = "6px";
        li.style.borderBottom = "1px solid #ddd";
        li.style.cursor = "pointer";

        li.innerHTML = `👨‍🎓 <strong>${s.name}</strong> (${s.email || '-'})`;

        li.onclick = () => {
          alert(`Επιλέξατε τον φοιτητή: ${s.name}`);
          searchInput.value = s.name;
          studentResults.innerHTML = '';
        };

        ul.appendChild(li);
      });

      studentResults.appendChild(ul);

    } catch (err) {
      console.error(err);
      studentResults.innerHTML = "<p>❌ Σφάλμα κατά την αναζήτηση.</p>";
    }
  }
  // ✅ Εδώ βάλε τις συναρτήσεις
  async function loadTopics() {
    const res = await fetch('http://localhost:5000/api/instructors/topics', {
      headers: { Authorization: `Bearer ${token}` }
    });
    const topics = await res.json();

    const topicList = document.getElementById('topicList');
    topicList.innerHTML = '';

    if (Array.isArray(topics)) {
      topics.forEach(t => {
        const div = document.createElement('div');
        div.className = 'topic';
        div.innerHTML = `
          <strong>${t.title}</strong><br>${t.summary}<br>
          <button onclick="editTopic('${t._id}')">✏️ Επεξεργασία</button>
          <button onclick="assignTopic('${t._id}')">📎 Ανάθεση</button>`;
        topicList.appendChild(div);
      });
    } else {
      topicList.innerHTML = 'Σφάλμα φόρτωσης θεμάτων.';
      console.log('topics:', topics);
    }
  }

  async function loadAssignments() {
  const res = await fetch('http://localhost:5000/api/instructors/assignments', {
    headers: { Authorization: `Bearer ${token}` }
  });

  const assignments = await res.json();
  const assignmentList = document.getElementById('assignmentList');
  assignmentList.innerHTML = '';

  if (assignments.length === 0) {
    assignmentList.innerHTML = '<p>📭 Δεν υπάρχουν ενεργές αναθέσεις.</p>';
    return;
  }

  assignments.forEach(a => {
    const div = document.createElement('div');
    div.className = 'topic';
    div.innerHTML = `
      <strong>${a.title}</strong><br>
      Ανατέθηκε σε: 👨‍🎓 ${a.assignedTo?.name || 'Άγνωστος'} (${a.assignedTo?.email || '-'})<br>
      <button onclick="cancelAssignment('${a._id}')">🗑️ Ακύρωση Ανάθεσης</button>
    `;
    assignmentList.appendChild(div);
  });
}


  async function assignTopic(topicId) {
  const studentEmail = prompt("📧 Εισάγετε email φοιτητή για ανάθεση:");

  if (!studentEmail) return;

  try {
    // Αναζήτηση φοιτητή με email
    const resStudent = await fetch(`http://localhost:5000/api/students/search?email=${encodeURIComponent(studentEmail)}`, {
      headers: { Authorization: `Bearer ${token}` }
    });

    const students = await resStudent.json();
    if (students.length === 0) {
      alert("❌ Δεν βρέθηκε φοιτητής με αυτό το email.");
      return;
    }

    const studentId = students[0]._id;

    // Ανάθεση θέματος
    const resAssign = await fetch('http://localhost:5000/api/instructors/assign-topic', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({ topicId, studentId })
    });

    const result = await resAssign.json();
    if (resAssign.ok) {
      alert("✅ Το θέμα ανατέθηκε προσωρινά!");
      loadAssignments(); // προαιρετικά
    } else {
      alert("❌ Σφάλμα κατά την ανάθεση: " + result.message);
    }

  } catch (err) {
    console.error(err);
    alert("❌ Σφάλμα επικοινωνίας με τον server.");
  }
}

async function cancelAssignment(topicId) {
  if (!confirm("❓ Θέλετε σίγουρα να ακυρώσετε την ανάθεση;")) return;

  try {
    const res = await fetch('http://localhost:5000/api/instructors/cancel-assignment', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({ topicId })
    });

    const result = await res.json();
    if (res.ok) {
      alert("✅ Η ανάθεση ακυρώθηκε.");
      loadAssignments();
    } else {
      alert("❌ Σφάλμα: " + result.message);
    }
  } catch (err) {
    console.error(err);
    alert("❌ Σφάλμα επικοινωνίας με τον server.");
  }
}


  function editTopic(id) {
    window.location.href = `edit-topic.html?id=${id}`;
  }

    loadTopics();
    loadAssignments();
  </script>

</body>
</html>
